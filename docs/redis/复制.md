# 复制

> 本质就是一主多从

## 配置

- 配置文件添加：`slaveof 主数据库地址 主数据库端口`
- 启动时增加参数（断开连接新数据库）：`—- slaveof 主数据库地址 主数据库端口`

获取相关复制信息：`info replication`
> 默认情况下，从数据库都是只读懂，如果直接修改数据库的数据会出现错误，可以通过设置配置文件的`slave-read-only no`使从数据库可以写，但是不建议。

- `slaveof no one`：使当前数据库停止接收其他数据库的同步并转换成为主数据库

## 原理

### 复制初始化

1. 从数据库向主数据库发送 sync 命令
2. 主数据库接收后，开始RDB持久化生成快照，并将期间接收到的命令缓存起来，当快照完成后和缓存命令一起发送给从数据库
3. 从数据库接收快照文件并执行缓存命令

> 同步过程中从数据库并不会阻塞，默认会使用同步前的数据进行响应，可以使用`slave-serve-stale-data no`使从数据库完成同步前对所有命令响应错误：`sync with master in progress`。
> 断线重连：2.6之前采用重新复制初始化，2.8之后进行增量数据传输。

### 复制同步阶段

主数据库执行任何会导致数据变化的命令都会异步的传送给从数据库。

Redis采用乐观复制策略，容忍一定程度的主从数据库内容不同，但两者最终同步，也就是先返回结果再同步数据库，这一特性保证启用复制的主数据库性能不会受影响。

但这一特性无法感知同步了几个数据库，可以通过配置设置同步了几个从数据库，主数据库才是可写。

- `min-slaves-to-write 3`：只有3个或3个以上的从数据库连接到主数据库，才是可写的
- `min-slaves-max-lag 10`：允许从数据库最长失去连接到时间